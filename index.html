<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>The Gub</title>
  <meta name="description" content="Click da Gub" />
  <meta property="og:type"        content="website" />
  <meta property="og:url"         content="https://gub.cam/" />
  <meta property="og:title"       content="The Gub" />
  <meta property="og:description" content="click and pet the gub" />
  <meta property="og:image"       content="https://gub.cam/gub_wicked.png" />

  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <style>
    body { margin:0; overflow:hidden; background:#111; position:relative; height:100vh; width:100vw; }
    #main-gub { max-height:90vh; max-width:90vw; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:1; }

    
    #btnRow { position:absolute; top:10px; left:10px; display:flex; gap:5px; z-index:9999; }
    #btnRow button { background:#fff; color:#000; border:none; border-radius:6px; cursor:pointer; font-weight:bold; font-family:sans-serif; padding:8px 16px; font-size:14px; }

    
    #perfMenu { position:absolute; top:50px; left:10px; z-index:9998; background:#222; color:#fff; border:1px solid #555; border-radius:6px; padding:8px; display:none; font-family:sans-serif; font-size:14px; }
    #perfMenu button { margin:2px 4px; padding:4px 8px; border:none; border-radius:4px; background:#444; color:#fff; cursor:pointer; }

    .rainbow-text { font-size:2rem; font-weight:bold; font-family:sans-serif; animation:rainbow 5s linear infinite; white-space:nowrap; position:absolute; pointer-events:none; z-index:2; }
    .floater      { position:absolute; pointer-events:none; z-index:2; }
    .floater img  { width:100%; height:100%; object-fit:contain; }

    @keyframes rainbow {0%{color:red;}20%{color:orange;}40%{color:yellow;}60%{color:green;}80%{color:blue;}100%{color:violet;}}
    @keyframes pop {
  0%   { transform: translate(-50%, -50%) scale(1); }
  50%  { transform: translate(-50%, -50%) scale(1.1); }
  100% { transform: translate(-50%, -50%) scale(1); }
}
.pop-effect {
  animation: pop 0.15s ease-out both;
}

#main-gub {
  cursor: pointer; /* show it’s clickable */
}
    @media (max-width: 768px) {
  #discordBtn {
    bottom: 170px !important;   /* move it up above the chat */
    right: 10px !important;     /* keep it flush to the right edge */
  }
  #golden-counter {
    top: 60px !important; /* push it down under the btnRow (which sits at 10px + ~40px height) */
  }
}
 
#shopBtn {
  position: absolute;
  top: 40px;
  right: 10px;
  z-index: 10000;
  background: #fff;
  color: #000;
  border: none;
  border-radius: 6px;
  padding: 8px 16px;
  font-weight: bold;
  font-family: sans-serif;
  cursor: pointer;
}

#shopPanel {
  position: absolute;
  top: 90px;
  right: 10px;
  display: none;
  background: #222;
  color: #fff;
  padding: 8px;
  border-radius: 6px;
  z-index: 10000;
}
  #shopPanel h4 {
  font-size: 2rem;    /* makes it roughly 32px tall */
  font-weight: bold;  /* extra emphasis */
  margin-top: 0;
  margin-bottom: 0.5em;
}


    #visualizer {
  position: fixed;
  bottom: 0;
  left: calc(50% + 280px);
  transform: translateX(-50%);
  width: 80vw;
  height: 100px;
  z-index: 5000;
  pointer-events: none;
}
    
#online-users {
  position: absolute;
  bottom: 10px;
  left: 499px;
  background: rgba(0,0,0,0.6);
  color: #fff;
  padding: 6px 10px;
  border-radius: 6px;
  font-family: sans-serif;
  font-size: 14px;
  z-index: 10001;
}
    #twitchPlayer  { position:absolute; top:50px; right:10px; width:500px; height:300px; z-index:9000; display:none; box-shadow:0 0 8px #000; border-radius:8px; overflow:hidden; }
    #golden-counter { position:absolute; top:10px; right:10px; z-index:10000; color:white; font-family:sans-serif; font-size:20px; font-weight:bold; }
    #leaderboard { position:absolute; bottom:10px; left:10px; background:rgba(0,0,0,0.6); color:#fff; padding:10px; border-radius:6px; font-family:sans-serif; z-index:10000; }
    #discordBtn {
  position: absolute;
  bottom: 10px;
  right: 10px;
  background: #7289da;
  color: white;
  border: none;
  border-radius: 4px;
  padding: 8px 12px;
  font-family: sans-serif;
  font-size: 14px;
  cursor: pointer;
  text-decoration: none;
  z-index: 10000;
}
#discordBtn:hover {
  background: #5b6eae;
}

    #chat {
  position: absolute;
  bottom: 10px;
  left: 196px;         
  width: 300px;
  max-height: 150px;   /* match leaderboard height or adjust */
  border-radius: 8px;
  background: rgba(0,0,0,0.6);
  color: #fff;
  font-family: sans-serif;
  padding: 8px;
  box-sizing: border-box;
  z-index: 10000;
  display: flex;
  flex-direction: column;
}
#messages {
  flex: 1;
  overflow-y: auto;
  margin-bottom: 8px;
  font-size: 12px;
}
#chatForm {
  display: flex;
}
#chatInput {
  flex: 1;
  padding: 4px;
  font-size: 12px;
}
#chatForm button {
  padding: 4px 8px;
  margin-left: 4px;
  font-size: 12px;
}

  </style>
  <script src="https://embed.twitch.tv/embed/v1.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
</head>
<body>
  <div id="btnRow">
    <button id="lowPerfBtn">Settings Menu</button>
    <button id="chaosBtn">Chaos Mode <span style="font-size:10px;">(epilepsy warning)</span></button>
    <button id="twitchBtn">Show Stream</button>
  </div>
<button id="shopBtn">Shop</button>

  <div id="shopPanel">
    <h4>Shop</h4>
    <div id="shopItemsContainer"></div>
  </div>

  <div id="perfMenu">
    <div>Speed: <button id="spdDec">-</button><span id="spdVal">2</span><button id="spdInc">+</button></div>
    <div>Images: <button id="imgDec">-</button><span id="imgVal">20</span><button id="imgInc">+</button></div>
    <div><button id="moveToggle">Pause Movement</button></div>
    <label for="volumeSlider" style="margin-top:8px; display:block; color:#fff; font-weight:bold;">
  Chaos Volume
</label>
<input
  id="volumeSlider"
  type="range"
  min="0" max="1" step="0.01"
  style="width:100%; margin-top:4px;"
/>
  </div>
  <div id="golden-counter">Gubs: 0</div>
  <div id="online-users">
    Online: …
  </div>
  <div id="leaderboard"><strong>Leaderboard</strong><br>Loading…</div>
  <div id="chat">
  <div id="messages"></div>
  <form id="chatForm">
    <input id="chatInput" type="text" placeholder="Type a message…" autocomplete="off" />
    <button type="submit">Send</button>
  </form>
</div>
  <div id="twitchPlayer"></div>
  <img id="main-gub" src="gub_wicked.png" alt="wickeding gub" />
  <canvas id="visualizer"></canvas>
  <script>
  window.addEventListener('DOMContentLoaded', () => {
const isMobile = window.innerWidth < 768;
const NUM_FLOATERS = isMobile ? 5 : 20;
const chaosAudio = new Audio('music.mp3');
chaosAudio.loop = true;
// restore saved volume or default to 0.5
const stored = parseFloat(localStorage.getItem('gubVolume'));
chaosAudio.volume = isNaN(stored) ? 0.5 : stored;

      const volumeSlider = document.getElementById('volumeSlider');        // 1a: grab the slider element
    volumeSlider.value = chaosAudio.volume;                             // 1b: initialize its position
    volumeSlider.addEventListener('input', () => {                     // 1c: listen for changes
      chaosAudio.volume = volumeSlider.value;
      localStorage.setItem('gubVolume', volumeSlider.value);
    });

    let flashing = false;
    let musicPlaying = false;
    
        // ─── VISUALIZER SETUP ────────────────────────────────────────────────
    const canvas   = document.getElementById('visualizer');
    const ctx      = canvas.getContext('2d');
    function resize(){ canvas.width = window.innerWidth; canvas.height = 100; }
    window.addEventListener('resize', resize);
    resize();

    // Hook the visualizer up to our chaosAudio element
    const audioCtx   = new (window.AudioContext||window.webkitAudioContext)();
    const analyser   = audioCtx.createAnalyser();
    const sourceNode = audioCtx.createMediaElementSource(chaosAudio);
    sourceNode.connect(analyser);
    analyser.connect(audioCtx.destination);
    analyser.fftSize = 256;

    window.addEventListener('touchstart', () => {
      if (audioCtx.state === 'suspended') audioCtx.resume();
      }, { once: true });
    window.addEventListener('click', () => {
      if (audioCtx.state === 'suspended') audioCtx.resume();
      }, { once: true });

    const bufferLength = analyser.frequencyBinCount;
    const dataArray    = new Uint8Array(bufferLength);

    function drawVis(){
      requestAnimationFrame(drawVis);
      analyser.getByteFrequencyData(dataArray);
      ctx.clearRect(0,0,canvas.width,canvas.height);
      const barWidth = canvas.width / bufferLength;
      for(let i=0; i<bufferLength; i++){
        const h = dataArray[i];
        ctx.fillStyle = `hsl(${i*3},100%,50%)`;
        ctx.fillRect(i*barWidth, canvas.height-h, barWidth-1, h);
      }
    }
    drawVis();
    // ─────────────────────────────────────────────────────────────────────


// ─── SPECIAL GUB STYLE ───────────────────────────────────────────────────
const specialStyle = document.createElement('style');
specialStyle.textContent = `
  .special-gub {
    position: absolute;
    filter: hue-rotate(30deg) saturate(3) brightness(1.3);
    border: none;
    pointer-events: auto;
    z-index: 10001;
    font-family: sans-serif;
    font-weight: bold;
    color: white;
    text-align: center;
    text-shadow: 0 0 5px black;
    outline: none;
  }
    .special-gub:focus {
    outline: none;        /* ← ensure no outline even when focused */
  }
`;
document.head.appendChild(specialStyle);   
    // 1. Prompt & sanitize username
    let username = (localStorage.getItem('gubUser') || '').trim();
    if (!username) {
      do {
        username = (prompt('Enter a username for the leaderboard:') || '').trim();
      } while (!username);
      username = username.replace(/[.#$[\]]/g, '_');
      localStorage.setItem('gubUser', username);
    }

    // 2. Initialize Firebase
const firebaseConfig = {
  apiKey: "AIzaSyBc2cDT3md2pk28dFMDoCeCgw37tpGBEjM",
  authDomain: "gub-leaderboard.firebaseapp.com",
  databaseURL: "https://gub-leaderboard-default-rtdb.firebaseio.com",
  projectId: "gub-leaderboard",
  storageBucket: "gub-leaderboard.firebasestorage.app",
  messagingSenderId: "851465760203",
  appId: "1:851465760203:web:1fc30c730a93c0fab25a4e",
  measurementId: "G-95SE4H7EEW"
};
    firebase.initializeApp(firebaseConfig);

    // 3. Authenticate then setup leaderboard
firebase.auth().signInAnonymously().then(() => {
  const db  = firebase.database();
  const uid = firebase.auth().currentUser.uid;

        // ─── Presence Setup ───────────────────────────────────────────────
  const presenceRef   = db.ref('.info/connected');
  const userOnlineRef = db.ref('presence/' + username);

  presenceRef.on('value', snap => {
    if (snap.val() === true) {
      userOnlineRef.set(true);
      userOnlineRef.onDisconnect().remove();
    }
  });

  db.ref('presence').on('value', snap => {
    const users = snap.val() ? Object.keys(snap.val()) : [];
    document.getElementById('online-users').textContent =
      'Online: ' + users.join(', ');
  });
  // ─────────────────────────────────────────────────────────────────

      let sessionCount = 0, globalCount = 0;

      // Load or initialize user's score
const userRef = db.ref(`leaderboard/${username}/score`);
userRef.once('value').then(snap => {
  globalCount = snap.val() || 0;

  renderCounter();
  // Ensure entry exists
  db.ref(`leaderboard/${username}`).set({ score: globalCount });
  
// Real-time leaderboard updates
db.ref('leaderboard').on('value', snap => {
  const list = [];
  snap.forEach(child => {
    list.push({ user: child.key, score: child.val().score || 0 });
  });
  list.sort((a, b) => b.score - a.score);
  document.getElementById('leaderboard').innerHTML =
    '<strong>Leaderboard</strong><br>' +
    list.map((e, i) => `${i+1}. ${e.user}: ${e.score}`).join('<br>');
});

  // ——— Chat setup ———
// 1. References to your Firebase “chat” node and DOM elements
const chatRef    = db.ref('chat');
const messagesEl = document.getElementById('messages');
const chatForm   = document.getElementById('chatForm');
const chatInput  = document.getElementById('chatInput');

// 2. Listen for new chat messages (last 100), append them in order
chatRef
  .orderByChild('ts')
  .limitToLast(100)
  .on('child_added', snap => {
    const { user, text, ts } = snap.val();
    const msgEl = document.createElement('div');
    // format timestamp as HH:MM:SS
    const time  = new Date(ts).toLocaleTimeString();
    msgEl.textContent = `[${time}] ${user}: ${text}`;
    messagesEl.appendChild(msgEl);
    // scroll to bottom
    messagesEl.scrollTop = messagesEl.scrollHeight;
  });

// 3. Hook up the form so sending pushes a new message
chatForm.addEventListener('submit', e => {
  e.preventDefault();
  const text = chatInput.value.trim();
  if (!text) return;
  chatRef.push({
    user: username,    // your sanitized username from localStorage
    text: text,
    ts: Date.now()
  });
  chatInput.value = '';
});

  // Start spawning golden gubs
  scheduleNextGolden(true);
});


      // Update leaderboard display
function updateLeaderboard() {
  db.ref('leaderboard')
    .once('value')
    .then(snap => {
      const list = [];
      snap.forEach(c => {
        // pull the score (defaulting to 0 if it’s missing)
        const score = c.val().score || 0;
        list.push({ user: c.key, score });
      });
      // sort descending
      list.sort((a, b) => b.score - a.score);

      document.getElementById('leaderboard').innerHTML =
        '<strong>Leaderboard</strong><br>' +
        list.map((e, i) => `${i + 1}. ${e.user}: ${e.score}`).join('<br>');
    })
    .catch(err => console.error('Failed to load leaderboard:', err));
}



      // Spawn golden gub and handle clicks
      function spawnGolden() {
        const el = document.createElement('img');
        el.src = images[Math.floor(Math.random()*images.length)];
        el.className = 'floater';
        const size = 80 + Math.random()*320;
        el.style.width = el.style.height = size + 'px';
        el.style.left = `${Math.random()*(window.innerWidth-size)}px`;
        el.style.top  = `${Math.random()*(window.innerHeight-size)}px`;
        el.style.zIndex = 10000;
        el.style.filter = 'sepia(1) hue-rotate(20deg) saturate(5) brightness(1.2)';
        el.style.border = '2px solid white';
        el.style.pointerEvents = 'auto';
        document.body.appendChild(el);
        el.addEventListener('click', () => {
          sessionCount +=15;
          globalCount +=15;
          renderCounter();
          db.ref(`leaderboard/${username}`).set({ score: globalCount });
          updateLeaderboard();
          el.remove();
          scheduleNextGolden();
        });
      }
      // ─── SPECIAL GUB SPAWNER ───────────────────────────────────────────────
function spawnSpecialGub() {
  // 1. pick the exact same random image
  const imgSrc = images[Math.floor(Math.random() * images.length)];

  // 2. container for image + label
  const container = document.createElement('div');
  container.className = 'floater special-gub';
  const size = 80 + Math.random() * 320;
  container.style.width  = size + 'px';
  container.style.height = size + 'px';
  container.style.left   = `${Math.random()*(window.innerWidth-size)}px`;
  container.style.top    = `${Math.random()*(window.innerHeight-size)}px`;

  // 3. the image element itself
  const img = document.createElement('img');
  img.src           = imgSrc;
  img.style.width   = '100%';
  img.style.height  = '100%';
  img.style.objectFit = 'contain';
  // orange-ify it
  img.style.filter  = 'hue-rotate(30deg) saturate(3) brightness(1.3)';
  container.appendChild(img);

  // 4. overlay the label
  const label = document.createElement('div');
  label.textContent = 'SPESHAL GUB';
  Object.assign(label.style, {
    position:      'absolute',
    top:           '0',
    left:          '0',
    width:         '100%',
    height:        '100%',
    display:       'flex',
    alignItems:    'center',
    justifyContent:'center',
    fontFamily:    'sans-serif',
    fontWeight:    'bold',
    color:         'white',
    textShadow:    '0 0 5px black',
    pointerEvents: 'none'
  });
  container.appendChild(label);

  document.body.appendChild(container);

  // 5. click handler awards +5
  container.addEventListener('click', () => {
    sessionCount += 50;
    globalCount  += 50;
    renderCounter();
    db.ref(`leaderboard/${username}`).set({ score: globalCount });
    updateLeaderboard();
    container.remove();
    scheduleNextGolden();
  });
}

      // ─── UPDATED SCHEDULER ──────────────────
function scheduleNextGolden(initial = false) {
  const min = initial ? 3000 : 5000;
  const max = initial ? 10000 : 15000;
  setTimeout(() => {
    if (Math.random() < 0.2) spawnSpecialGub();
    else                 spawnGolden();
  }, min + Math.random() * (max - min));
}
      // Expose goldenCounterEl for spawn
      const goldenCounterEl = document.getElementById('golden-counter');
      
      function renderCounter() {
        goldenCounterEl.textContent = 'Gubs: ' + Math.floor(globalCount);
      }
      // main gub handler
const mainGub = document.getElementById('main-gub');
let popTimeout;

      mainGub.addEventListener('click', () => {
        sessionCount++;
        globalCount++;
        renderCounter();
        db.ref(`leaderboard/${username}`).set({ score: globalCount });
        updateLeaderboard();

        mainGub.classList.remove('pop-effect');
        void mainGub.offsetWidth;
        mainGub.classList.add('pop-effect');

        clearTimeout(popTimeout);
        popTimeout = setTimeout(() => mainGub.classList.remove('pop-effect'), 150);
      });
 // ─── SHOP CODE (moved here!) ─────────────────────────────────────────
    const shopItems = [
      { id: 'passiveMaker', name: 'The Gub', cost: 100, rate: 1   },
      { id: 'guberator',     name: 'Guberator', cost: 500, rate: 5   },
      { id: 'gubmill',       name: 'Gubmill',   cost: 2000, rate: 20 }
    ];
    const shopRef = db.ref(`shop/${uid}`);
    const owned = { passiveMaker:0, guberator:0, gubmill:0 };
    let totalRate = 0;

const shopBtn       = document.getElementById('shopBtn');
const shopPanel     = document.getElementById('shopPanel');
const shopContainer = document.getElementById('shopItemsContainer');

shopBtn.addEventListener('click', () => {
  shopPanel.style.display = shopPanel.style.display === 'block' ? 'none' : 'block';
});

shopItems.forEach(item => {
  const div = document.createElement('div');
  div.innerHTML = `
    <strong>${item.name}</strong><br>
    Cost: ${item.cost} Gubs<br>
    Rate: ${item.rate} Gubs/min<br>
    Owned: <span id="owned-${item.id}">0</span><br>
    <button id="buy-${item.id}">Buy</button>
    <hr style="border-color:#444">
  `;
  shopContainer.appendChild(div);

  div.querySelector(`#buy-${item.id}`).addEventListener('click', () => {
    if (globalCount >= item.cost) {
      globalCount -= item.cost;
      totalRate   += item.rate;
      owned[item.id] += 1;
      document.getElementById(`owned-${item.id}`).textContent = owned[item.id];
      renderCounter();
      db.ref(`shop/${uid}/${item.id}`).set(owned[item.id]);
      db.ref(`leaderboard/${username}`).set({ score: Math.floor(globalCount) });
    }
  });
});
  
shopRef.once('value').then(snapshot => {
  const stored = snapshot.val() || {};
  shopItems.forEach(item => {
    owned[item.id] = stored[item.id] || 0;
    document.getElementById(`owned-${item.id}`).textContent = owned[item.id];
  });
  totalRate = shopItems.reduce((sum, it) => sum + owned[it.id] * it.rate, 0);
});
    // passive income timer
    setInterval(()=>{
      if (totalRate > 0) {
        globalCount += totalRate;
        renderCounter();
        db.ref(`leaderboard/${username}`).set({ score: Math.floor(globalCount) });
      }
    }, 60_000);
    // ──────────────────────────────────────────────────────────────────────
      
    }).catch(err => console.error('Auth Error', err));

    // --- Game Logic & Controls (unchanged) ---
    const images = ['floater1.jpg','floater2.jpg','floater3.jpg','floater4.png','floater5.jpg','floater6.jpg','floater7.jpg','floater8.jpg','floater9.jpg','floater10.jpg','floater11.jpg','floater12.jpg','floater13.jpg','floater14.jpg','floater15.jpg','floater16.jpg','floater17.png','floater18.jpg'];
    const texts = ["bark","barke","gubbling","good boye","sniffa","shidded","gubb","gubbing","i'm gonna gub","he do be gubbin","were my salami go","Gub Gubtaro Pissboy420 Bong or Die","bork","aaaAAa","im gubbing it im gubbing it"];
    let speedMultiplier = 2, numFloaters = NUM_FLOATERS;
    const floaters = [];
    function createEntity(isText=false){
      const elem = document.createElement('div');
      const size = 80 + Math.random() * 320;
      elem.style.width = elem.style.height = size + 'px';
      elem.style.left = Math.random() * (window.innerWidth - size) + 'px';
      elem.style.top  = Math.random() * (window.innerHeight - size) + 'px';
      if(isText){
        elem.className = 'rainbow-text';
        elem.textContent = texts[Math.floor(Math.random()*texts.length)];
      } else {
        elem.className = 'floater';
        const img = document.createElement('img');
        img.src = images[Math.floor(Math.random()*images.length)];
        elem.appendChild(img);
      }
      document.body.appendChild(elem);
      floaters.push({ elem, x: parseFloat(elem.style.left), y: parseFloat(elem.style.top), vx: (Math.random()-0.5)*2, vy: (Math.random()-0.5)*2, width: size, height: size });
    }
    function removeEntity(){ const f = floaters.pop(); if(f) f.elem.remove(); }
    function animate(){
      floaters.forEach(f => {
        f.x += f.vx * speedMultiplier;
        f.y += f.vy * speedMultiplier;
        if(f.x <= 0 || f.x + f.width >= window.innerWidth) f.vx *= -1;
        if(f.y <= 0 || f.y + f.height >= window.innerHeight) f.vy *= -1;
        f.elem.style.left = f.x + 'px';
        f.elem.style.top  = f.y + 'px';
      });
      requestAnimationFrame(animate);
    }
    for(let i=0; i<NUM_FLOATERS; i++){ createEntity(false); createEntity(true);}   
    animate();
    // Controls
    const settingsBtn = document.getElementById('lowPerfBtn');
    const perfMenu   = document.getElementById('perfMenu');
    const spdDec     = document.getElementById('spdDec');
    const spdInc     = document.getElementById('spdInc');
    const imgDec     = document.getElementById('imgDec');
    const imgInc     = document.getElementById('imgInc');
    const spdVal     = document.getElementById('spdVal');
    const imgVal     = document.getElementById('imgVal');
    const moveToggle = document.getElementById('moveToggle');

    let movementPaused = false;
    let storedSpeed = speedMultiplier;

    settingsBtn.onclick = () => { perfMenu.style.display = perfMenu.style.display==='block' ? 'none' : 'block'; };
    function updateLabels(){ spdVal.textContent = speedMultiplier; imgVal.textContent = numFloaters; }
    function adjustSpeed(d){
      if(movementPaused){
        storedSpeed = Math.max(1, storedSpeed + d);
      } else {
        speedMultiplier = Math.max(1, speedMultiplier + d);
      }
      updateLabels();
    }
    function adjustImages(d){
      const newVal = Math.max(2, numFloaters + d);
      if(newVal !== numFloaters){
        if(d>0) for(let i=0; i<d; i++){ createEntity(false); createEntity(true); }
        else     for(let i=0; i<-d; i++){ removeEntity(); removeEntity(); }
        numFloaters = newVal;
        updateLabels();
      }
    }
    spdDec.onclick = () => adjustSpeed(-1);
    spdInc.onclick = () => adjustSpeed(1);
    imgDec.onclick = () => adjustImages(-2);
    imgInc.onclick = () => adjustImages(2);
    moveToggle.onclick = () => {
      if(!movementPaused){
        storedSpeed = speedMultiplier;
        speedMultiplier = 0;
        moveToggle.textContent = 'Resume Movement';
      } else {
        speedMultiplier = storedSpeed;
        moveToggle.textContent = 'Pause Movement';
      }
      movementPaused = !movementPaused;
      updateLabels();
    };
    updateLabels();

    // Twitch & Chaos Mode
    const chaosBtn  = document.getElementById('chaosBtn');
    const twitchBtn = document.getElementById('twitchBtn');
    const twitchBox = document.getElementById('twitchPlayer');
    let twitchShown = false;

    twitchBtn.onclick = () => {
      if(!twitchShown){
        twitchBox.style.display = 'block';
        new Twitch.Embed('twitchPlayer',{ width:'100%', height:'100%', channel:'harupi', layout:'video', parent:[location.hostname] });
        twitchBtn.textContent = 'Hide Stream';
      } else {
        twitchBox.innerHTML = '';
        twitchBox.style.display = 'none';
        twitchBtn.textContent = 'Show Stream';
      }
      twitchShown = !twitchShown;
    };
   


chaosBtn.addEventListener('click', () => {
  flashing = !flashing;

  floaters.forEach(f => {
    const dur  = (0.3 + Math.random() * 0.7).toFixed(2);
    const dir  = Math.random() > 0.5 ? 'alternate' : 'alternate-reverse';
    const ease = Math.random() > 0.5 ? 'ease-in'   : 'ease-out';
    if (flashing) {
      // turn ON chaos: add animations
      if (f.elem.classList.contains('rainbow-text')) {
        f.elem.style.animation = `rainbow 5s linear infinite, spinmove ${dur}s infinite ${dir} ${ease}`;
      } else {
        f.elem.style.animation = `spinmove ${dur}s infinite ${dir} ${ease}`;
      }
    } else {
      // turn OFF chaos: remove any animation
      f.elem.style.animation = '';
    }
  });

  if (flashing) {
    document.body.style.animation = 'flash 0.1s infinite alternate';
    if (audioCtx.state === 'suspended') audioCtx.resume();
    if (!musicPlaying) {
      chaosAudio.play().catch(() => {});
      musicPlaying = true;
    }
  } else {
    document.body.style.animation = 'none';
    chaosAudio.pause();
    musicPlaying = false;
  }
  updateLabels();
});

    const styleEl = document.createElement('style');
    styleEl.textContent = `@keyframes flash{0%{background:#111}25%{background:#ff0}50%{background:#0ff}75%{background:#f0f}100%{background:#111}}@keyframes spinmove{0%{transform:scale(1) rotate(0deg)}50%{transform:scale(1.2) rotate(180deg)}100%{transform:scale(1) rotate(360deg)}}`;
    document.head.appendChild(styleEl);
  });
  </script>
  <script>
    // Ensure persisted username is sanitized before use in Firebase paths
    window.addEventListener('DOMContentLoaded', () => {
      const stored = localStorage.getItem('gubUser');
      if (stored) {
        const safe = stored.replace(/[.#$[\]]/g, '_');
        if (safe !== stored) {
          localStorage.setItem('gubUser', safe);
        }
      }
    });
  </script>
  <a id="discordBtn" href="https://discord.gg/nutpit" target="_blank" rel="noopener">
  Discord
</a>
</body>
</html>
