<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>the gub</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <style>
    body { margin:0; overflow:hidden; background:#111; position:relative; height:100vh; width:100vw; }
    #main-gub { max-height:90vh; max-width:90vw; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:1; }

    /* Top-left button row */
    #btnRow { position:absolute; top:10px; left:10px; display:flex; gap:5px; z-index:9999; }
    #btnRow button { background:#fff; color:#000; border:none; border-radius:6px; cursor:pointer; font-weight:bold; font-family:sans-serif; padding:8px 16px; font-size:14px; }

    /* Performance menu */
    #perfMenu { position:absolute; top:50px; left:10px; z-index:9998; background:#222; color:#fff; border:1px solid #555; border-radius:6px; padding:8px; display:none; font-family:sans-serif; font-size:14px; }
    #perfMenu button { margin:2px 4px; padding:4px 8px; border:none; border-radius:4px; background:#444; color:#fff; cursor:pointer; }

    .rainbow-text { font-size:2rem; font-weight:bold; font-family:sans-serif; animation:rainbow 5s linear infinite; white-space:nowrap; position:absolute; pointer-events:none; z-index:2; }
    .floater      { position:absolute; pointer-events:none; z-index:2; }
    .floater img  { width:100%; height:100%; object-fit:contain; }

    @keyframes rainbow {0%{color:red;}20%{color:orange;}40%{color:yellow;}60%{color:green;}80%{color:blue;}100%{color:violet;}}
    @media(max-width:768px) {.floater,.rainbow-text{max-width:150px;max-height:150px;}}

    #visualizer    { position:fixed; bottom:0; left:0; right:0; width:100vw; height:100px; z-index:5000; pointer-events:none; }
    #twitchPlayer  { position:absolute; top:50px; right:10px; width:500px; height:300px; z-index:9000; display:none; box-shadow:0 0 8px #000; border-radius:8px; overflow:hidden; }
    #golden-counter { position:absolute; top:10px; right:10px; z-index:10000; color:gold; font-family:sans-serif; font-size:20px; font-weight:bold; }
    #leaderboard { position:absolute; bottom:10px; left:10px; background:rgba(0,0,0,0.6); color:#fff; padding:10px; border-radius:6px; font-family:sans-serif; z-index:10000; }
  </style>
  <script src="https://embed.twitch.tv/embed/v1.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
</head>
<body>
  <div id="btnRow">
    <button id="lowPerfBtn">Settings Menu</button>
    <button id="chaosBtn">Chaos Mode <span style="font-size:10px;">(epilepsy warning)</span></button>
    <button id="twitchBtn">Show Stream</button>
  </div>
  <div id="perfMenu">
    <div>Speed: <button id="spdDec">-</button><span id="spdVal">2</span><button id="spdInc">+</button></div>
    <div>Images: <button id="imgDec">-</button><span id="imgVal">20</span><button id="imgInc">+</button></div>
  </div>
  <div id="golden-counter">Golden Gubs This Session: 0</div>
  <div id="leaderboard"><strong>Leaderboard</strong><br>Loading…</div>
  <div id="twitchPlayer"></div>
  <img id="main-gub" src="gub_wicked.png" alt="wickeding gub" />
  <canvas id="visualizer"></canvas>
  <script>
  window.addEventListener('DOMContentLoaded', () => {
    // 1. Prompt & sanitize username
    let username = (localStorage.getItem('gubUser') || '').trim();
    if (!username) {
      do {
        username = (prompt('Enter a username for the leaderboard:') || '').trim();
      } while (!username);
      username = username.replace(/[.#$[\]]/g, '_');
      localStorage.setItem('gubUser', username);
    }

    // 2. Initialize Firebase
const firebaseConfig = {
  apiKey: "AIzaSyBc2cDT3md2pk28dFMDoCeCgw37tpGBEjM",
  authDomain: "gub-leaderboard.firebaseapp.com",
  databaseURL: "https://gub-leaderboard-default-rtdb.firebaseio.com",
  projectId: "gub-leaderboard",
  storageBucket: "gub-leaderboard.firebasestorage.app",
  messagingSenderId: "851465760203",
  appId: "1:851465760203:web:1fc30c730a93c0fab25a4e",
  measurementId: "G-95SE4H7EEW"
};
    firebase.initializeApp(firebaseConfig);

    // 3. Authenticate then setup leaderboard
    firebase.auth().signInAnonymously().then(() => {
      const db = firebase.database();
      let sessionCount = 0, globalCount = 0;

      // Load or initialize user's score
const userRef = db.ref(`leaderboard/${username}/score`);
userRef.once('value').then(snap => {
  globalCount = snap.val() || 0;
  // Ensure entry exists
  db.ref(`leaderboard/${username}`).set({ score: globalCount });

  // Populate initial leaderboard
  updateLeaderboard();

  // Refresh leaderboard every 10 seconds
  setInterval(updateLeaderboard, 10_000);

  // Start spawning golden gubs
  scheduleNextGolden(true);
});


      // Update leaderboard display
function updateLeaderboard() {
  db.ref('leaderboard')
    .once('value')
    .then(snap => {
      const list = [];
      snap.forEach(c => {
        // pull the score (defaulting to 0 if it’s missing)
        const score = c.val().score || 0;
        list.push({ user: c.key, score });
      });
      // sort descending
      list.sort((a, b) => b.score - a.score);

      document.getElementById('leaderboard').innerHTML =
        '<strong>Leaderboard</strong><br>' +
        list.map((e, i) => `${i + 1}. ${e.user}: ${e.score}`).join('<br>');
    })
    .catch(err => console.error('Failed to load leaderboard:', err));
}



      // Spawn golden gub and handle clicks
      function spawnGolden() {
        const el = document.createElement('img');
        el.src = images[Math.floor(Math.random()*images.length)];
        el.className = 'floater';
        const size = 80 + Math.random()*320;
        el.style.width = el.style.height = size + 'px';
        el.style.left = `${Math.random()*(window.innerWidth-size)}px`;
        el.style.top  = `${Math.random()*(window.innerHeight-size)}px`;
        el.style.zIndex = 10000;
        el.style.filter = 'sepia(1) hue-rotate(20deg) saturate(5) brightness(1.2)';
        el.style.border = '2px solid gold';
        el.style.pointerEvents = 'auto';
        document.body.appendChild(el);
        el.addEventListener('click', () => {
          sessionCount++;
          globalCount++;
          goldenCounterEl.textContent = `Golden Gubs This Session: ${sessionCount}`;
          db.ref(`leaderboard/${username}`).set({ score: globalCount });
          updateLeaderboard();
          el.remove();
          scheduleNextGolden();
        });
      }

      function scheduleNextGolden(initial=false) {
        const min = initial?3000:5000;
        const max = initial?10000:15000;
        setTimeout(spawnGolden, min + Math.random()*(max-min));
      }

      // Expose goldenCounterEl for spawn
      const goldenCounterEl = document.getElementById('golden-counter');
    }).catch(err => console.error('Auth Error', err));

    // --- Game Logic & Controls (unchanged) ---
    const NUM_FLOATERS = 20;
    const images = ['floater1.jpg','floater2.jpg','floater3.jpg','floater4.png','floater5.jpg','floater6.jpg','floater7.jpg','floater8.jpg','floater9.jpg','floater10.jpg','floater11.jpg','floater12.jpg'];
    const texts = ["bark","barke","gubbling","good boye","sniffa","shidded","gubb","gubbing","i'm gonna gub","he do be gubbin","were my salami go","Gub Gubtaro Pissboy420 Bong or Die","bork","aaaAAa","im gubbing it im gubbing it"];
    let speedMultiplier = 2, numFloaters = NUM_FLOATERS;
    const floaters = [];
    function createEntity(isText=false){
      const elem = document.createElement('div');
      const size = 80 + Math.random() * 320;
      elem.style.width = elem.style.height = size + 'px';
      elem.style.left = Math.random() * (window.innerWidth - size) + 'px';
      elem.style.top  = Math.random() * (window.innerHeight - size) + 'px';
      if(isText){
        elem.className = 'rainbow-text';
        elem.textContent = texts[Math.floor(Math.random()*texts.length)];
      } else {
        elem.className = 'floater';
        const img = document.createElement('img');
        img.src = images[Math.floor(Math.random()*images.length)];
        elem.appendChild(img);
      }
      document.body.appendChild(elem);
      floaters.push({ elem, x: parseFloat(elem.style.left), y: parseFloat(elem.style.top), vx: (Math.random()-0.5)*2, vy: (Math.random()-0.5)*2, width: size, height: size });
    }
    function removeEntity(){ const f = floaters.pop(); if(f) f.elem.remove(); }
    function animate(){
      floaters.forEach(f => {
        f.x += f.vx * speedMultiplier;
        f.y += f.vy * speedMultiplier;
        if(f.x <= 0 || f.x + f.width >= window.innerWidth) f.vx *= -1;
        if(f.y <= 0 || f.y + f.height >= window.innerHeight) f.vy *= -1;
        f.elem.style.left = f.x + 'px';
        f.elem.style.top  = f.y + 'px';
      });
      requestAnimationFrame(animate);
    }
    for(let i=0; i<NUM_FLOATERS; i++){ createEntity(false); createEntity(true);}   
    animate();

    // Controls
    const settingsBtn = document.getElementById('lowPerfBtn');
    const perfMenu   = document.getElementById('perfMenu');
    const spdDec     = document.getElementById('spdDec');
    const spdInc     = document.getElementById('spdInc');
    const imgDec     = document.getElementById('imgDec');
    const imgInc     = document.getElementById('imgInc');
    const spdVal     = document.getElementById('spdVal');
    const imgVal     = document.getElementById('imgVal');

    settingsBtn.onclick = () => { perfMenu.style.display = perfMenu.style.display==='block' ? 'none' : 'block'; };
    function updateLabels(){ spdVal.textContent = speedMultiplier; imgVal.textContent = numFloaters; }
    function adjustSpeed(d){ speedMultiplier = Math.max(1, speedMultiplier + d); updateLabels(); }
    function adjustImages(d){
      const newVal = Math.max(2, numFloaters + d);
      if(newVal !== numFloaters){
        if(d>0) for(let i=0; i<d; i++){ createEntity(false); createEntity(true); }
        else     for(let i=0; i<-d; i++){ removeEntity(); removeEntity(); }
        numFloaters = newVal;
        updateLabels();
      }
    }
    spdDec.onclick = () => adjustSpeed(-1);
    spdInc.onclick = () => adjustSpeed(1);
    imgDec.onclick = () => adjustImages(-2);
    imgInc.onclick = () => adjustImages(2);
    updateLabels();

    // Twitch & Chaos Mode
    const chaosBtn  = document.getElementById('chaosBtn');
    const twitchBtn = document.getElementById('twitchBtn');
    const twitchBox = document.getElementById('twitchPlayer');
    let twitchShown = false;

    twitchBtn.onclick = () => {
      if(!twitchShown){
        twitchBox.style.display = 'block';
        new Twitch.Embed('twitchPlayer',{ width:'100%', height:'100%', channel:'harupi', layout:'video', parent:[location.hostname] });
        twitchBtn.textContent = 'Hide Stream';
      } else {
        twitchBox.innerHTML = '';
        twitchBox.style.display = 'none';
        twitchBtn.textContent = 'Show Stream';
      }
      twitchShown = !twitchShown;
    };

    let flashing = false, musicPlaying = false;
    const canvas   = document.getElementById('visualizer');
    const ctx      = canvas.getContext('2d');
    function resize(){ canvas.width = window.innerWidth; canvas.height = 100; }
    window.addEventListener('resize', resize);
    resize();
    const audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    const analyser = audioCtx.createAnalyser(); analyser.fftSize = 256;
    const bufferLength = analyser.frequencyBinCount;
    const dataArray    = new Uint8Array(bufferLength);
    const audio        = new Audio('music.mp3'); audio.loop = true;
    const source       = audioCtx.createMediaElementSource(audio);
    source.connect(analyser); analyser.connect(audioCtx.destination);
    function drawVis(){
      requestAnimationFrame(drawVis);
      analyser.getByteFrequencyData(dataArray);
      ctx.clearRect(0,0,canvas.width,canvas.height);
      const barWidth = canvas.width / bufferLength;
      for(let i=0; i<bufferLength; i++){
        const h = dataArray[i];
        ctx.fillStyle = `hsl(${i*3},100%,50%)`;
        ctx.fillRect(i*barWidth, canvas.height-h, barWidth-1, h);
      }
    }

    const goldenCounterEl = document.getElementById('golden-counter');
    function spawnGolden(){
      const imgSrc = images[Math.floor(Math.random()*images.length)];
      const el     = document.createElement('img'); el.src = imgSrc; el.className = 'floater';
      const size = 80 + Math.random()*320; el.style.width = el.style.height = size+'px';
      el.style.left = Math.random()*(window.innerWidth-size)+'px';
      el.style.top  = Math.random()*(window.innerHeight-size)+'px';
      el.style.zIndex = 10000;
      el.style.filter = 'sepia(1) hue-rotate(20deg) saturate(5) brightness(1.2)';
      el.style.border = '2px solid gold';
      el.style.pointerEvents = 'auto';
      document.body.appendChild(el);
      el.addEventListener('click', () => {
        sessionCount++;
        globalCount++;
        goldenCounterEl.textContent = 'Golden Gubs This Session: ' + sessionCount;
        db.ref(`leaderboard/${username}`).set({ score: globalCount });
        updateLeaderboard();
        el.remove();
        scheduleNextGolden();
      });
    }
    function scheduleNextGolden(initial=false){ const min=initial?3000:5000, max=initial?10000:15000; setTimeout(spawnGolden, min + Math.random()*(max-min)); }

    chaosBtn.addEventListener('click', () => {
      flashing = !flashing;
      floaters.forEach(f => {
        const dur = (0.3 + Math.random()*0.7).toFixed(2);
        const dir = Math.random()>0.5 ? 'alternate':'alternate-reverse';
        const ease= Math.random()>0.5 ? 'ease-in':'ease-out';
        if(f.elem.classList.contains('rainbow-text'))
          f.elem.style.animation = `rainbow 5s linear infinite, spinmove ${dur}s infinite ${dir} ${ease}`;
        else
          f.elem.style.animation = `spinmove ${dur}s infinite ${dir} ${ease}`;
      });
      if(flashing){
        document.body.style.animation = 'flash 0.1s infinite alternate';
        if(!musicPlaying){ audioCtx.resume(); audio.play(); drawVis(); musicPlaying = true; }
      } else {
        document.body.style.animation = 'none'; document.body.style.background = '#111';
        floaters.forEach(f => f.elem.style.animation = '');
        if(musicPlaying){ audio.pause(); musicPlaying = false; }
      }
      updateLabels();
    });

    const styleEl = document.createElement('style');
    styleEl.textContent = `@keyframes flash{0%{background:#111}25%{background:#ff0}50%{background:#0ff}75%{background:#f0f}100%{background:#111}}@keyframes spinmove{0%{transform:scale(1) rotate(0deg)}50%{transform:scale(1.2) rotate(180deg)}100%{transform:scale(1) rotate(360deg)}}`;
    document.head.appendChild(styleEl);
  });
  </script>
  <script>
    // Ensure persisted username is sanitized before use in Firebase paths
    window.addEventListener('DOMContentLoaded', () => {
      const stored = localStorage.getItem('gubUser');
      if (stored) {
        const safe = stored.replace(/[.#$[\]]/g, '_');
        if (safe !== stored) {
          localStorage.setItem('gubUser', safe);
        }
      }
    });
  </script>
</body>
</html>
